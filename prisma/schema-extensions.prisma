// Calendar & Events Schema Extension

model Event {
  id          String   @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  allDay      Boolean  @default(false)
  location    String?

  // Relations
  caseId      String?
  case        Case?    @relation(fields: [caseId], references: [id], onDelete: Cascade)

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  // Reminders
  reminders   EventReminder[]

  // Recurrence
  isRecurring Boolean  @default(false)
  recurrence  Json?    // {frequency: 'daily'|'weekly'|'monthly', interval: number, endDate: string}

  // Metadata
  color       String?  @default("#3b82f6")
  status      EventStatus @default(SCHEDULED)
  priority    Priority @default(MEDIUM)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([caseId])
  @@index([userId])
  @@index([startDate])
  @@index([status])
}

model EventReminder {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  minutesBefore Int    // 15, 30, 60, 1440 (24h)
  sent        Boolean  @default(false)
  sentAt      DateTime?

  createdAt   DateTime @default(now())

  @@index([eventId])
  @@index([sent])
}

enum EventStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Tasks Schema Extension

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?

  // Relations
  caseId      String?
  case        Case?    @relation(fields: [caseId], references: [id], onDelete: Cascade)

  assignedTo  String
  user        User     @relation(fields: [assignedTo], references: [id])

  createdBy   String
  creator     User     @relation("TaskCreator", fields: [createdBy], references: [id])

  // Task Details
  status      TaskStatus @default(PENDING)
  priority    Priority   @default(MEDIUM)

  dueDate     DateTime?
  completedAt DateTime?

  // Estimation
  estimatedHours Float?
  actualHours    Float?

  // Checklist
  checklist   Json?    // [{id: string, text: string, completed: boolean}]

  // Attachments
  attachments String[] // Array of file paths

  // Tags
  tags        String[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([caseId])
  @@index([assignedTo])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  REVIEW
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Notifications Schema Extension

model Notification {
  id          String   @id @default(cuid())

  // Recipient
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  email       String?  // For client notifications

  // Content
  type        NotificationType
  title       String
  message     String
  templateId  String?

  // Context
  caseId      String?
  case        Case?    @relation(fields: [caseId], references: [id], onDelete: Cascade)

  taskId      String?
  eventId     String?

  // Metadata
  channel     NotificationChannel
  status      NotificationStatus @default(PENDING)

  sentAt      DateTime?
  readAt      DateTime?
  errorMessage String?

  // Scheduling
  scheduledFor DateTime?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([scheduledFor])
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_DUE
  TASK_OVERDUE
  EVENT_REMINDER
  CASE_UPDATE
  PAYMENT_RECEIVED
  INVOICE_GENERATED
  DOCUMENT_UPLOADED
  DEADLINE_APPROACHING
  CUSTOM
}

enum NotificationChannel {
  EMAIL
  IN_APP
  BOTH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  SCHEDULED
}

model NotificationTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  subject     String
  body        String   // Supports template variables: {{variable}}
  type        NotificationType

  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Finance Schema Extension

model FinancialAgreement {
  id          String   @id @default(cuid())

  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  // Agreement Details
  type        AgreementType
  totalAmount Decimal  @db.Decimal(12, 2)
  currency    String   @default("USD")

  // Fee Structure
  hourlyRate      Decimal? @db.Decimal(10, 2)
  contingencyRate Decimal? @db.Decimal(5, 2) // Percentage
  flatFee         Decimal? @db.Decimal(12, 2)
  retainerAmount  Decimal? @db.Decimal(12, 2)

  // Payment Terms
  paymentTerms    String?
  installments    Int?     @default(1)

  // Status
  status          AgreementStatus @default(ACTIVE)
  signedDate      DateTime?

  // Tracking
  paidAmount      Decimal  @default(0) @db.Decimal(12, 2)
  balanceAmount   Decimal  @db.Decimal(12, 2) // Computed: totalAmount - paidAmount

  payments        Payment[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([caseId])
  @@index([status])
}

enum AgreementType {
  HOURLY
  CONTINGENCY
  FLAT_FEE
  RETAINER
  HYBRID
}

enum AgreementStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

model Payment {
  id          String   @id @default(cuid())

  agreementId String
  agreement   FinancialAgreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)

  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  // Payment Details
  amount      Decimal  @db.Decimal(12, 2)
  currency    String   @default("USD")
  method      PaymentMethod

  // Reference
  referenceNumber String?
  invoiceNumber   String?

  // Dates
  paymentDate DateTime
  receivedDate DateTime?

  // Status
  status      PaymentStatus @default(PENDING)

  // Notes
  notes       String?

  createdBy   String
  user        User     @relation(fields: [createdBy], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([agreementId])
  @@index([caseId])
  @@index([status])
  @@index([paymentDate])
}

enum PaymentMethod {
  CASH
  CHECK
  BANK_TRANSFER
  CREDIT_CARD
  PAYPAL
  OTHER
}

enum PaymentStatus {
  PENDING
  RECEIVED
  CLEARED
  BOUNCED
  REFUNDED
}

model Invoice {
  id          String   @id @default(cuid())

  invoiceNumber String @unique

  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  // Client Info
  clientName  String
  clientEmail String?

  // Invoice Details
  issueDate   DateTime @default(now())
  dueDate     DateTime

  // Line Items
  items       Json     // [{description: string, quantity: number, rate: number, amount: number}]

  // Amounts
  subtotal    Decimal  @db.Decimal(12, 2)
  taxRate     Decimal  @default(0) @db.Decimal(5, 2)
  taxAmount   Decimal  @default(0) @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)

  paidAmount  Decimal  @default(0) @db.Decimal(12, 2)
  balance     Decimal  @db.Decimal(12, 2)

  // Status
  status      InvoiceStatus @default(DRAFT)

  // Payment Info
  paymentTerms String?
  notes        String?

  // File
  pdfUrl       String?

  createdBy   String
  user        User     @relation(fields: [createdBy], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([caseId])
  @@index([status])
  @@index([invoiceNumber])
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

// Add relations to existing models

model Case {
  // Existing fields...

  events      Event[]
  tasks       Task[]
  notifications Notification[]
  agreements  FinancialAgreement[]
  payments    Payment[]
  invoices    Invoice[]
}

model User {
  // Existing fields...

  events      Event[]
  tasks       Task[]
  createdTasks Task[]  @relation("TaskCreator")
  notifications Notification[]
  payments    Payment[]
  invoices    Invoice[]
}
