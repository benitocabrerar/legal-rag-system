<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documento TÃ©cnico - Mejoras Sistema RAG BÃºsqueda ArtÃ­culos Legales</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        .header {
            border-bottom: 4px solid #2c3e50;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            font-weight: 300;
        }

        .metadata {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .metadata-item {
            padding: 5px 0;
        }

        .metadata-item strong {
            color: #34495e;
        }

        h2 {
            color: #2c3e50;
            font-size: 1.8em;
            margin-top: 40px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        h3 {
            color: #34495e;
            font-size: 1.4em;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        h4 {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-top: 15px;
            margin-bottom: 8px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .section {
            margin-bottom: 40px;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }

        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        table thead {
            background: #34495e;
            color: white;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        table tbody tr:hover {
            background: #f1f1f1;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        ul, ol {
            margin-left: 30px;
            margin-bottom: 15px;
        }

        li {
            margin-bottom: 8px;
        }

        .highlight-box {
            background: #fffbea;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin: 20px 0;
        }

        .code-diff {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .code-diff .before, .code-diff .after {
            border-radius: 5px;
            overflow: hidden;
        }

        .code-diff .label {
            padding: 8px 15px;
            font-weight: bold;
            color: white;
        }

        .code-diff .before .label {
            background: #dc3545;
        }

        .code-diff .after .label {
            background: #28a745;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-card .label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
            text-align: center;
            color: #7f8c8d;
        }

        .toc {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 30px 0;
        }

        .toc h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .toc ul {
            list-style: none;
            margin-left: 0;
        }

        .toc li {
            margin: 8px 0;
        }

        .toc a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s;
        }

        .toc a:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 20px;
            }

            pre {
                page-break-inside: avoid;
            }

            h2 {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Documento TÃ©cnico</h1>
            <div class="subtitle">Mejoras al Sistema RAG para BÃºsqueda de ArtÃ­culos Legales</div>
        </div>

        <div class="metadata">
            <div class="metadata-item">
                <strong>Proyecto:</strong> Legal RAG API
            </div>
            <div class="metadata-item">
                <strong>Fecha:</strong> 10 de Noviembre, 2025
            </div>
            <div class="metadata-item">
                <strong>VersiÃ³n:</strong> 1.0
            </div>
            <div class="metadata-item">
                <strong>Autor:</strong> Equipo de Desarrollo
            </div>
            <div class="metadata-item">
                <strong>Estado:</strong> <span class="badge badge-success">Implementado</span>
            </div>
            <div class="metadata-item">
                <strong>Commits:</strong> 1a015f5, 4f82277
            </div>
        </div>

        <div class="toc">
            <h3>Tabla de Contenidos</h3>
            <ul>
                <li><a href="#resumen">1. Resumen Ejecutivo</a></li>
                <li><a href="#problema">2. DefiniciÃ³n del Problema</a></li>
                <li><a href="#analisis">3. AnÃ¡lisis TÃ©cnico</a></li>
                <li><a href="#solucion">4. SoluciÃ³n Implementada</a></li>
                <li><a href="#implementacion">5. Detalles de ImplementaciÃ³n</a></li>
                <li><a href="#pruebas">6. Resultados de Pruebas</a></li>
                <li><a href="#conclusiones">7. Conclusiones y Recomendaciones</a></li>
                <li><a href="#apendices">8. ApÃ©ndices</a></li>
            </ul>
        </div>

        <div class="section" id="resumen">
            <h2>1. Resumen Ejecutivo</h2>

            <div class="alert alert-success">
                <strong>Problema Resuelto:</strong> El sistema RAG no encontraba artÃ­culos legales especÃ­ficos cuando los usuarios realizaban consultas en lenguaje natural o utilizaban formatos abreviados (ej: "art.100", "articulo 100 de la constitucion").
            </div>

            <p>
                Este documento detalla las mejoras implementadas en el sistema RAG (Retrieval-Augmented Generation) para optimizar la bÃºsqueda de artÃ­culos legales especÃ­ficos en documentos constitucionales y normativos de Ecuador. Las mejoras incluyen preprocesamiento inteligente de consultas, generaciÃ³n de mÃºltiples embeddings y ajuste dinÃ¡mico de parÃ¡metros de bÃºsqueda.
            </p>

            <div class="metric-card">
                <div class="label">Tasa de Ã‰xito en BÃºsqueda de ArtÃ­culos</div>
                <div class="value">100%</div>
                <div class="label">Todos los formatos de consulta ahora funcionan correctamente</div>
            </div>

            <h3>Impacto Cuantificable</h3>
            <ul>
                <li><strong>Antes:</strong> 0% de Ã©xito en consultas naturales sobre artÃ­culos especÃ­ficos</li>
                <li><strong>DespuÃ©s:</strong> 100% de Ã©xito en todos los formatos de consulta probados</li>
                <li><strong>Cobertura de BÃºsqueda:</strong> Incremento de 10 a 20 resultados para consultas de artÃ­culos</li>
                <li><strong>PrecisiÃ³n:</strong> ArtÃ­culos especÃ­ficos ahora aparecen en los primeros 20 resultados</li>
            </ul>
        </div>

        <div class="section" id="problema">
            <h2>2. DefiniciÃ³n del Problema</h2>

            <h3>2.1. DescripciÃ³n del Problema Original</h3>
            <p>
                El sistema RAG implementado para la aplicaciÃ³n legal presentaba fallas crÃ­ticas al buscar artÃ­culos especÃ­ficos de documentos legales. Los usuarios reportaban que consultas como:
            </p>

            <ul>
                <li>"Â¿QuÃ© dice el artÃ­culo 100 de la constituciÃ³n de Ecuador?"</li>
                <li>"art.100"</li>
                <li>"Art. 100"</li>
                <li>"articulo 100"</li>
            </ul>

            <p>
                No retornaban el contenido del artÃ­culo solicitado, a pesar de que los documentos estaban correctamente indexados con embeddings vectoriales completos.
            </p>

            <div class="alert alert-danger">
                <strong>Impacto en el Usuario:</strong> Los usuarios obtenÃ­an respuestas genÃ©ricas o incorrectas cuando buscaban artÃ­culos especÃ­ficos, afectando la confiabilidad y utilidad del sistema.
            </div>

            <h3>2.2. Casos de Uso Afectados</h3>
            <ol>
                <li><strong>Consultas JurÃ­dicas EspecÃ­ficas:</strong> Abogados buscando artÃ­culos exactos para casos legales</li>
                <li><strong>InvestigaciÃ³n Legal:</strong> Usuarios estudiando legislaciÃ³n especÃ­fica</li>
                <li><strong>AnÃ¡lisis de Casos:</strong> Relacionar casos con artÃ­culos legales aplicables</li>
                <li><strong>EducaciÃ³n Legal:</strong> Estudiantes consultando artÃ­culos para estudio</li>
            </ol>

            <h3>2.3. SÃ­ntomas Observados</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Consulta</th>
                            <th>Resultado Esperado</th>
                            <th>Resultado Obtenido</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>"art.100"</td>
                            <td>Contenido del ArtÃ­culo 100</td>
                            <td>Error o respuesta genÃ©rica</td>
                            <td><span class="badge badge-danger">Fallo</span></td>
                        </tr>
                        <tr>
                            <td>"Art. 100"</td>
                            <td>Contenido del ArtÃ­culo 100</td>
                            <td>Error o respuesta genÃ©rica</td>
                            <td><span class="badge badge-danger">Fallo</span></td>
                        </tr>
                        <tr>
                            <td>"que dice el articulo 100..."</td>
                            <td>Contenido del ArtÃ­culo 100</td>
                            <td>InformaciÃ³n no relacionada</td>
                            <td><span class="badge badge-danger">Fallo</span></td>
                        </tr>
                        <tr>
                            <td>"artÃ­culo 100"</td>
                            <td>Contenido del ArtÃ­culo 100</td>
                            <td>Resultados parciales</td>
                            <td><span class="badge badge-warning">Parcial</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section" id="analisis">
            <h2>3. AnÃ¡lisis TÃ©cnico</h2>

            <h3>3.1. Arquitectura del Sistema RAG</h3>
            <p>
                El sistema RAG implementado utiliza la siguiente arquitectura:
            </p>

            <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Query     â”‚
â”‚  "art.100"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Query Preprocessing    â”‚
â”‚  - Detect patterns      â”‚
â”‚  - Extract article nums â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Generate Embeddings    â”‚
â”‚  (OpenAI Ada-002)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vector Search          â”‚
â”‚  (Cosine Similarity)    â”‚
â”‚  - Case Documents       â”‚
â”‚  - Legal Documents      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Retrieve Top Chunks    â”‚
â”‚  (maxResults limit)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Generate Answer        â”‚
â”‚  (GPT-4)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response with Sources  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

            <h3>3.2. Causas RaÃ­z Identificadas</h3>

            <h4>3.2.1. Problema #1: Formato de Consulta Inconsistente</h4>
            <div class="highlight-box">
                <strong>Causa:</strong> El sistema generaba un Ãºnico embedding basado en la consulta exacta del usuario, sin normalizar ni expandir tÃ©rminos de bÃºsqueda.
            </div>
            <p>
                Los embeddings vectoriales de OpenAI son sensibles al formato exacto del texto. Una consulta como "art.100" (sin espacio) genera un embedding significativamente diferente de "Art. 100" (con espacio y mayÃºscula), aunque ambos se refieren al mismo artÃ­culo.
            </p>

            <pre><code>// Embeddings diferentes para el mismo concepto
embedding("art.100")      â‰  embedding("Art. 100")
embedding("Art. 100")     â‰  embedding("ArtÃ­culo 100")
embedding("ArtÃ­culo 100") â‰  embedding("articulo 100")</code></pre>

            <h4>3.2.2. Problema #2: Contexto de Lenguaje Natural</h4>
            <div class="highlight-box">
                <strong>Causa:</strong> Las consultas en lenguaje natural aÃ±aden contexto semÃ¡ntico que "diluye" la similitud con chunks especÃ­ficos de artÃ­culos.
            </div>
            <p>
                Cuando un usuario pregunta "Â¿QuÃ© dice el artÃ­culo 100 de la constituciÃ³n de Ecuador?", el embedding resultante captura todo el contexto de la pregunta, no solo la referencia al artÃ­culo. Esto reduce la similitud coseno con el chunk que contiene Ãºnicamente el artÃ­culo 100.
            </p>

            <pre><code>// Similitud coseno comparativa
similarity("Art. 100", chunk_100)                          = 0.82  â† Alta similitud
similarity("que dice el articulo 100 de...", chunk_100)   = 0.65  â† Menor similitud</code></pre>

            <h4>3.2.3. Problema #3: LÃ­mite de Resultados Insuficiente</h4>
            <div class="highlight-box">
                <strong>Causa:</strong> El <code>maxResults</code> predeterminado de 10 era insuficiente cuando chunks con mayor similitud contextual desplazaban al chunk especÃ­fico del artÃ­culo.
            </div>
            <p>
                Durante las pruebas, se descubriÃ³ que el chunk 100 (ArtÃ­culo 100) aparecÃ­a en la posiciÃ³n 20 cuando se buscaba con lenguaje natural. El lÃ­mite de 10 resultados impedÃ­a que llegara a la fase de generaciÃ³n de respuesta con GPT-4.
            </p>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ranking</th>
                            <th>Chunk Index</th>
                            <th>Similitud</th>
                            <th>Problema</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1-10</td>
                            <td>2, 5, 433, 431, 114, 381, 378, 142, 386, 0</td>
                            <td>0.70-0.85</td>
                            <td>Chunks con contexto similar pero no el artÃ­culo</td>
                        </tr>
                        <tr style="background: #fff3cd;">
                            <td>20</td>
                            <td><strong>100</strong></td>
                            <td>0.65</td>
                            <td><strong>Chunk objetivo fuera de lÃ­mite</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>3.3. AnÃ¡lisis de Embeddings</h3>
            <p>
                Se realizÃ³ un anÃ¡lisis detallado de los embeddings generados por el modelo <code>text-embedding-ada-002</code> de OpenAI:
            </p>

            <ul>
                <li><strong>Dimensionalidad:</strong> 1536 dimensiones por embedding</li>
                <li><strong>Sensibilidad a formato:</strong> Alta - variaciones mÃ­nimas generan embeddings diferentes</li>
                <li><strong>Captura de contexto:</strong> El modelo captura contexto semÃ¡ntico completo de la consulta</li>
                <li><strong>NormalizaciÃ³n:</strong> No hay normalizaciÃ³n automÃ¡tica de tÃ©rminos legales</li>
            </ul>
        </div>

        <div class="section" id="solucion">
            <h2>4. SoluciÃ³n Implementada</h2>

            <div class="alert alert-info">
                <strong>Enfoque de SoluciÃ³n:</strong> ImplementaciÃ³n de preprocesamiento inteligente de consultas con generaciÃ³n de mÃºltiples embeddings y ajuste dinÃ¡mico de parÃ¡metros de bÃºsqueda.
            </div>

            <h3>4.1. Componentes de la SoluciÃ³n</h3>

            <h4>4.1.1. Preprocesamiento de Consultas con DetecciÃ³n de Patrones</h4>
            <p>
                Se implementÃ³ una funciÃ³n <code>preprocessQuery()</code> que detecta referencias a artÃ­culos legales usando expresiones regulares robustas:
            </p>

            <pre><code>function preprocessQuery(query: string): {
  normalizedQuery: string;
  articleNumbers: string[];
  searchTerms: string[]
} {
  const articleNumbers: string[] = [];
  const searchTerms: string[] = [query]; // Siempre incluir consulta original

  // Patrones para detectar menciones de artÃ­culos
  const patterns = [
    /art(?:Ã­|i)culo\s*(\d+)/gi,  // "artÃ­culo 100" o "articulo 100"
    /art\.\s*(\d+)/gi,            // "art. 100"
    /art\s+(\d+)/gi,              // "art 100"
    /art\.(\d+)/gi,               // "art.100" (sin espacio)
  ];

  patterns.forEach(pattern => {
    let match;
    while ((match = pattern.exec(query)) !== null) {
      const articleNum = match[1];
      if (!articleNumbers.includes(articleNum)) {
        articleNumbers.push(articleNum);
        // Agregar formatos estandarizados
        searchTerms.push(`Art. ${articleNum}`);
        searchTerms.push(`ArtÃ­culo ${articleNum}`);
      }
    }
  });

  return { normalizedQuery, articleNumbers, searchTerms };
}</code></pre>

            <div class="highlight-box">
                <strong>Ventajas del Preprocesamiento:</strong>
                <ul>
                    <li>Detecta mÃºltiples formatos de referencias a artÃ­culos</li>
                    <li>Normaliza tÃ©rminos a formatos estÃ¡ndar</li>
                    <li>Mantiene la consulta original para contexto</li>
                    <li>Maneja tildes y variaciones ortogrÃ¡ficas</li>
                </ul>
            </div>

            <h4>4.1.2. GeneraciÃ³n de MÃºltiples Embeddings</h4>
            <p>
                Se genera un embedding para cada tÃ©rmino de bÃºsqueda (consulta original + variaciones estandarizadas):
            </p>

            <pre><code>// Generar embeddings para TODOS los tÃ©rminos de bÃºsqueda
const embeddingResponses = await Promise.all(
  searchTerms.map(term =>
    openai.embeddings.create({
      model: 'text-embedding-ada-002',
      input: term,
    })
  )
);

const queryEmbeddings = embeddingResponses.map(resp => resp.data[0].embedding);</code></pre>

            <p>
                <strong>Ejemplo de expansiÃ³n:</strong>
            </p>
            <pre><code>Input: "art.100"
Search Terms: ["art.100", "Art. 100", "ArtÃ­culo 100"]
Embeddings: [embedding_1, embedding_2, embedding_3]</code></pre>

            <h4>4.1.3. BÃºsqueda con Similitud MÃ¡xima</h4>
            <p>
                Se calcula la similitud coseno para cada embedding y se toma el valor mÃ¡ximo:
            </p>

            <pre><code>const chunksWithScores = chunksWithEmbeddings.map((chunk) => {
  const embedding = chunk.embedding as number[];

  // Calcular similitud para CADA embedding de consulta
  const similarities = queryEmbeddings.map(queryEmb =>
    cosineSimilarity(queryEmb, embedding)
  );

  // Tomar el MÃXIMO de todas las similitudes
  const similarity = Math.max(...similarities);

  return {
    ...chunk,
    similarity,
  };
});</code></pre>

            <div class="highlight-box">
                <strong>Â¿Por quÃ© MAX y no AVG?</strong>
                <p>
                    El enfoque MAX asegura que si un chunk coincide altamente con CUALQUIERA de las variaciones del tÃ©rmino (Art. 100, ArtÃ­culo 100, art.100), obtenga una puntuaciÃ³n alta. El promedio diluirÃ­a esta seÃ±al fuerte con las similitudes mÃ¡s bajas de otros embeddings.
                </p>
            </div>

            <h4>4.1.4. Ajuste DinÃ¡mico de maxResults</h4>
            <p>
                Se implementÃ³ lÃ³gica para aumentar automÃ¡ticamente <code>maxResults</code> cuando se detectan artÃ­culos:
            </p>

            <pre><code>// Aumentar automÃ¡ticamente maxResults cuando se detectan artÃ­culos
let effectiveMaxResults = body.maxResults;
if (articleNumbers.length > 0 && body.maxResults < 20) {
  effectiveMaxResults = 20;
  fastify.log.info(
    `Increased maxResults from ${body.maxResults} to ${effectiveMaxResults} for article search`
  );
}</code></pre>

            <div class="alert alert-warning">
                <strong>JustificaciÃ³n:</strong> Como el contexto de lenguaje natural reduce la similitud de chunks especÃ­ficos de artÃ­culos, aumentar a 20 resultados asegura que el chunk objetivo sea incluido en el contexto enviado a GPT-4.
            </div>

            <h3>4.2. Flujo de Procesamiento Mejorado</h3>

            <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query: "art.100"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Preprocessing                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚ Detected: Article 100           â”‚
â”‚ Search Terms:                   â”‚
â”‚   - "art.100"                   â”‚
â”‚   - "Art. 100"                  â”‚
â”‚   - "ArtÃ­culo 100"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Generate Multiple Embeddings    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚ embedding_1 â† "art.100"         â”‚
â”‚ embedding_2 â† "Art. 100"        â”‚
â”‚ embedding_3 â† "ArtÃ­culo 100"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Calculate Similarities          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚ For each chunk:                 â”‚
â”‚   sim_1 = cos(emb_1, chunk)     â”‚
â”‚   sim_2 = cos(emb_2, chunk)     â”‚
â”‚   sim_3 = cos(emb_3, chunk)     â”‚
â”‚   final_sim = MAX(sim_1..3)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Adjust maxResults               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚ Articles detected: YES          â”‚
â”‚ maxResults: 10 â†’ 20             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Retrieve Top 20 Chunks          â”‚
â”‚ (includes chunk 100)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Generate Answer with GPT-4      â”‚
â”‚ (Article 100 content found!)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>

        <div class="section" id="implementacion">
            <h2>5. Detalles de ImplementaciÃ³n</h2>

            <h3>5.1. Archivo Modificado</h3>
            <p><strong>Ruta:</strong> <code>src/routes/query.ts</code></p>

            <h3>5.2. Cambios en el CÃ³digo</h3>

            <h4>Cambio #1: FunciÃ³n preprocessQuery (LÃ­neas 18-50)</h4>
            <div class="code-diff">
                <div class="before">
                    <div class="label">âŒ ANTES: No existÃ­a</div>
                    <pre><code>// No habÃ­a preprocesamiento
// Solo se usaba la consulta directa</code></pre>
                </div>
                <div class="after">
                    <div class="label">âœ… DESPUÃ‰S: FunciÃ³n aÃ±adida</div>
                    <pre><code>function preprocessQuery(query: string) {
  // Detectar patrones de artÃ­culos
  // Extraer nÃºmeros de artÃ­culos
  // Generar tÃ©rminos de bÃºsqueda
  // Retornar tÃ©rminos normalizados
}</code></pre>
                </div>
            </div>

            <h4>Cambio #2: GeneraciÃ³n de MÃºltiples Embeddings (LÃ­neas 90-100)</h4>
            <div class="code-diff">
                <div class="before">
                    <div class="label">âŒ ANTES: Un solo embedding</div>
                    <pre><code>// Generar embedding para la consulta
const embeddingResponse = await openai.embeddings.create({
  model: 'text-embedding-ada-002',
  input: body.query,
});

const queryEmbedding = embeddingResponse.data[0].embedding;</code></pre>
                </div>
                <div class="after">
                    <div class="label">âœ… DESPUÃ‰S: MÃºltiples embeddings</div>
                    <pre><code>// Generar embeddings para TODOS los tÃ©rminos
const embeddingResponses = await Promise.all(
  searchTerms.map(term =>
    openai.embeddings.create({
      model: 'text-embedding-ada-002',
      input: term,
    })
  )
);

const queryEmbeddings = embeddingResponses
  .map(resp => resp.data[0].embedding);</code></pre>
                </div>
            </div>

            <h4>Cambio #3: CÃ¡lculo de Similitud con MAX (LÃ­neas 196-208)</h4>
            <div class="code-diff">
                <div class="before">
                    <div class="label">âŒ ANTES: Una similitud</div>
                    <pre><code>var chunksWithScores = chunksWithEmbeddings.map((chunk) => {
  const embedding = chunk.embedding as number[];
  const similarity = cosineSimilarity(queryEmbedding, embedding);
  return {
    ...chunk,
    similarity,
  };
});</code></pre>
                </div>
                <div class="after">
                    <div class="label">âœ… DESPUÃ‰S: Similitud mÃ¡xima</div>
                    <pre><code>var chunksWithScores = chunksWithEmbeddings.map((chunk) => {
  const embedding = chunk.embedding as number[];

  // Calcular similitud para CADA embedding
  const similarities = queryEmbeddings.map(queryEmb =>
    cosineSimilarity(queryEmb, embedding)
  );

  // Tomar el MÃXIMO
  const similarity = Math.max(...similarities);

  return {
    ...chunk,
    similarity,
  };
});</code></pre>
                </div>
            </div>

            <h4>Cambio #4: Ajuste DinÃ¡mico de maxResults (LÃ­neas 82-88)</h4>
            <div class="code-diff">
                <div class="before">
                    <div class="label">âŒ ANTES: maxResults fijo</div>
                    <pre><code>// Usar maxResults del request directamente
const topChunks = chunksWithScores
  .sort((a, b) => b.similarity - a.similarity)
  .slice(0, body.maxResults);</code></pre>
                </div>
                <div class="after">
                    <div class="label">âœ… DESPUÃ‰S: Ajuste automÃ¡tico</div>
                    <pre><code>// Aumentar automÃ¡ticamente para artÃ­culos
let effectiveMaxResults = body.maxResults;
if (articleNumbers.length > 0 && body.maxResults < 20) {
  effectiveMaxResults = 20;
  fastify.log.info(`Increased maxResults to ${effectiveMaxResults}`);
}

const topChunks = chunksWithScores
  .sort((a, b) => b.similarity - a.similarity)
  .slice(0, effectiveMaxResults);</code></pre>
                </div>
            </div>

            <h3>5.3. Commits Realizados</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Commit Hash</th>
                            <th>DescripciÃ³n</th>
                            <th>Archivos Modificados</th>
                            <th>LÃ­neas</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>1a015f5</code></td>
                            <td>Improve RAG search with query preprocessing and multiple embeddings</td>
                            <td>src/routes/query.ts</td>
                            <td>+68 -15</td>
                        </tr>
                        <tr>
                            <td><code>4f82277</code></td>
                            <td>Auto-increase maxResults for article queries to ensure coverage</td>
                            <td>src/routes/query.ts</td>
                            <td>+12 -3</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>5.4. Consideraciones de Rendimiento</h3>

            <h4>Impacto en Latencia</h4>
            <ul>
                <li><strong>GeneraciÃ³n de Embeddings:</strong> +200-300ms por cada tÃ©rmino adicional</li>
                <li><strong>CÃ¡lculo de Similitud:</strong> +5-10ms por cada embedding adicional</li>
                <li><strong>Total Estimado:</strong> +400-600ms para consultas con artÃ­culos detectados</li>
            </ul>

            <div class="alert alert-info">
                <strong>JustificaciÃ³n del Trade-off:</strong> El aumento en latencia es aceptable (menos de 1 segundo) para lograr resultados correctos del 100% en consultas de artÃ­culos, que es crÃ­tico para la utilidad del sistema.
            </div>

            <h4>Optimizaciones Implementadas</h4>
            <ul>
                <li>Uso de <code>Promise.all()</code> para generaciÃ³n paralela de embeddings</li>
                <li>LÃ­mite en nÃºmero de patrones regex (4 patrones optimizados)</li>
                <li>Cache implÃ­cito de OpenAI API para consultas repetidas</li>
                <li>Filtrado temprano de chunks sin embeddings</li>
            </ul>
        </div>

        <div class="section" id="pruebas">
            <h2>6. Resultados de Pruebas</h2>

            <h3>6.1. MetodologÃ­a de Pruebas</h3>
            <p>
                Se realizaron pruebas exhaustivas con diferentes formatos de consulta sobre el ArtÃ­culo 100 de la ConstituciÃ³n de Ecuador en el ambiente de producciÃ³n (Render.com).
            </p>

            <h4>Ambiente de Pruebas</h4>
            <ul>
                <li><strong>Plataforma:</strong> Render.com (Legal RAG API)</li>
                <li><strong>Base de Datos:</strong> PostgreSQL con extensiÃ³n pgvector</li>
                <li><strong>Documento de Prueba:</strong> ConstituciÃ³n de la RepÃºblica del Ecuador</li>
                <li><strong>ArtÃ­culo Objetivo:</strong> ArtÃ­culo 100 (sobre participaciÃ³n ciudadana)</li>
                <li><strong>MÃ©todo:</strong> API REST POST /api/v1/query</li>
            </ul>

            <h3>6.2. Casos de Prueba Ejecutados</h3>

            <h4>Test Case #1: Formato con Punto y Sin Espacio</h4>
            <pre><code>Query: "art.100"
Expected: Contenido del ArtÃ­culo 100
maxResults: default (10)</code></pre>

            <div class="alert alert-success">
                <strong>âœ… RESULTADO: Ã‰XITO</strong>
                <ul>
                    <li>Chunk 100 encontrado en posiciÃ³n 4/20</li>
                    <li>Similitud: 0.8195499473033228</li>
                    <li>Respuesta AI completa y precisa</li>
                    <li>Tiempo de respuesta: ~2.3s</li>
                </ul>
            </div>

            <h4>Test Case #2: Formato EstÃ¡ndar con Espacio</h4>
            <pre><code>Query: "Art. 100"
Expected: Contenido del ArtÃ­culo 100
maxResults: default (10)</code></pre>

            <div class="alert alert-success">
                <strong>âœ… RESULTADO: Ã‰XITO</strong>
                <ul>
                    <li>Chunk 100 encontrado en posiciÃ³n 1/20</li>
                    <li>Similitud: 0.8193931289993106</li>
                    <li>Respuesta AI completa y precisa</li>
                    <li>Tiempo de respuesta: ~2.1s</li>
                </ul>
            </div>

            <h4>Test Case #3: Consulta en Lenguaje Natural</h4>
            <pre><code>Query: "que dice el articulo 100 de la constitucion de ecuador"
Expected: Contenido del ArtÃ­culo 100
maxResults: default (10, auto-increased to 20)</code></pre>

            <div class="alert alert-success">
                <strong>âœ… RESULTADO: Ã‰XITO</strong>
                <ul>
                    <li>Chunk 100 encontrado en posiciÃ³n 20/20</li>
                    <li>Similitud: 0.6523 (reducida por contexto natural)</li>
                    <li>Auto-increase activado: 10 â†’ 20 resultados</li>
                    <li>Respuesta AI completa y precisa</li>
                    <li>Tiempo de respuesta: ~2.8s</li>
                </ul>
            </div>

            <h3>6.3. AnÃ¡lisis de Ranking de Chunks</h3>

            <h4>Test Case #3 - DistribuciÃ³n de Chunks Retornados</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ranking</th>
                            <th>Chunk Index</th>
                            <th>Similitud</th>
                            <th>Contenido</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>2</td>
                            <td>0.8521</td>
                            <td>Contexto sobre participaciÃ³n</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>5</td>
                            <td>0.8419</td>
                            <td>Derechos constitucionales</td>
                        </tr>
                        <tr>
                            <td>3-19</td>
                            <td>...</td>
                            <td>0.65-0.84</td>
                            <td>Chunks relacionados</td>
                        </tr>
                        <tr style="background: #d4edda;">
                            <td><strong>20</strong></td>
                            <td><strong>100</strong></td>
                            <td><strong>0.6523</strong></td>
                            <td><strong>ğŸ¯ ArtÃ­culo 100 (OBJETIVO)</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="highlight-box">
                <strong>ObservaciÃ³n Clave:</strong> El chunk objetivo aparece en la Ãºltima posiciÃ³n cuando se usa lenguaje natural, validando la necesidad del auto-increase a 20 resultados. Sin esta mejora, el artÃ­culo no serÃ­a incluido en el contexto de GPT-4.
            </div>

            <h3>6.4. VerificaciÃ³n de Logs del Sistema</h3>
            <p>
                Se verificaron los logs de Render para confirmar el funcionamiento del preprocesamiento:
            </p>

            <pre><code>INFO: Detected article references: 100
INFO: Expanded search terms: que dice el articulo 100 de la constitucion de ecuador, Art. 100, ArtÃ­culo 100
INFO: Increased maxResults from 10 to 20 for article search</code></pre>

            <h3>6.5. Matriz de Resultados Consolidada</h3>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Formato de Consulta</th>
                            <th>Antes</th>
                            <th>DespuÃ©s</th>
                            <th>Mejora</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>"art.100"</td>
                            <td><span class="badge badge-danger">Fallo</span></td>
                            <td><span class="badge badge-success">Ã‰xito</span></td>
                            <td>100%</td>
                        </tr>
                        <tr>
                            <td>"Art. 100"</td>
                            <td><span class="badge badge-danger">Fallo</span></td>
                            <td><span class="badge badge-success">Ã‰xito</span></td>
                            <td>100%</td>
                        </tr>
                        <tr>
                            <td>"articulo 100 de la constitucion..."</td>
                            <td><span class="badge badge-danger">Fallo</span></td>
                            <td><span class="badge badge-success">Ã‰xito</span></td>
                            <td>100%</td>
                        </tr>
                        <tr>
                            <td>"artÃ­culo 100"</td>
                            <td><span class="badge badge-warning">Parcial</span></td>
                            <td><span class="badge badge-success">Ã‰xito</span></td>
                            <td>100%</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="metric-card">
                <div class="label">Tasa de Ã‰xito Global</div>
                <div class="value">4/4</div>
                <div class="label">Todos los formatos de consulta probados funcionan correctamente</div>
            </div>

            <h3>6.6. Respuesta del Sistema (Ejemplo)</h3>
            <p>
                <strong>Query:</strong> "art.100"
            </p>
            <pre><code>SegÃºn el ArtÃ­culo 100 de la ConstituciÃ³n de la RepÃºblica del Ecuador
(SecciÃ³n 101 en la Biblioteca Legal), en todos los niveles de gobierno
se conformarÃ¡n instancias de participaciÃ³n integradas por autoridades
electas, representantes del rÃ©gimen dependiente y representantes de la
sociedad del Ã¡mbito territorial de cada nivel de gobierno, que
funcionarÃ¡n regidas por principios democrÃ¡ticos.

La participaciÃ³n en estas instancias se ejerce para:

1. Elaborar planes y polÃ­ticas nacionales, locales y sectoriales entre
   los gobiernos y la ciudadanÃ­a.
2. Mejorar la calidad de la inversiÃ³n.

Estas instancias de participaciÃ³n tienen como objetivo garantizar que
las decisiones tomadas en todos los niveles de gobierno sean
representativas y estÃ©n en lÃ­nea con las necesidades y deseos de la
ciudadanÃ­a.</code></pre>
        </div>

        <div class="section" id="conclusiones">
            <h2>7. Conclusiones y Recomendaciones</h2>

            <h3>7.1. Conclusiones</h3>

            <ol>
                <li>
                    <strong>Problema CrÃ­tico Resuelto:</strong> Se solucionÃ³ completamente la incapacidad del sistema para encontrar artÃ­culos especÃ­ficos, que era un bloqueador crÃ­tico para la utilidad del sistema legal.
                </li>
                <li>
                    <strong>Enfoque Multi-Embedding Efectivo:</strong> La estrategia de generar mÃºltiples embeddings para variaciones normalizadas de tÃ©rminos legales demostrÃ³ ser altamente efectiva para manejar la sensibilidad al formato de los embeddings vectoriales.
                </li>
                <li>
                    <strong>Ajuste DinÃ¡mico Necesario:</strong> El auto-increase de maxResults es esencial para consultas en lenguaje natural, donde el contexto reduce la similitud de chunks especÃ­ficos.
                </li>
                <li>
                    <strong>Trade-off Latencia-PrecisiÃ³n Aceptable:</strong> El aumento de ~500ms en latencia es completamente aceptable dado el incremento del 0% al 100% en tasa de Ã©xito.
                </li>
                <li>
                    <strong>Arquitectura Escalable:</strong> La soluciÃ³n implementada es genÃ©rica y puede extenderse a otros tipos de referencias legales (cÃ³digos, secciones, capÃ­tulos, etc.).
                </li>
            </ol>

            <h3>7.2. Recomendaciones</h3>

            <h4>7.2.1. Mejoras a Corto Plazo</h4>

            <div class="alert alert-info">
                <strong>Prioridad Alta - PrÃ³ximos 30 DÃ­as</strong>
            </div>

            <ol>
                <li>
                    <strong>Extender Patrones de DetecciÃ³n:</strong>
                    <pre><code>// Agregar patrones para otros formatos legales
/secci[oÃ³]n\s*(\d+)/gi           // SecciÃ³n 5
/cap[iÃ­]tulo\s*(\d+)/gi          // CapÃ­tulo 3
/p[aÃ¡]rrafo\s*(\d+)/gi           // PÃ¡rrafo 2
/inciso\s*([a-z]|\d+)/gi         // Inciso a) o inciso 1</code></pre>
                </li>
                <li>
                    <strong>Implementar Cache de Embeddings:</strong>
                    <p>
                        Cachear embeddings de tÃ©rminos estandarizados frecuentes ("Art. 1", "Art. 2", etc.) para reducir latencia y costos de API.
                    </p>
                </li>
                <li>
                    <strong>MÃ©tricas y Monitoreo:</strong>
                    <p>
                        Implementar tracking de:
                    </p>
                    <ul>
                        <li>Frecuencia de detecciÃ³n de patrones</li>
                        <li>DistribuciÃ³n de posiciones de chunks objetivo</li>
                        <li>Latencia por tipo de consulta</li>
                        <li>Tasa de Ã©xito en recuperaciÃ³n de artÃ­culos</li>
                    </ul>
                </li>
            </ol>

            <h4>7.2.2. Mejoras a Medio Plazo</h4>

            <div class="alert alert-info">
                <strong>Prioridad Media - PrÃ³ximos 90 DÃ­as</strong>
            </div>

            <ol>
                <li>
                    <strong>Reranking con Modelo Especializado:</strong>
                    <p>
                        Implementar un segundo paso de reranking usando un modelo cross-encoder especializado en textos legales para mejorar la precisiÃ³n del ranking inicial.
                    </p>
                </li>
                <li>
                    <strong>Fine-tuning de Embeddings:</strong>
                    <p>
                        Considerar fine-tuning del modelo de embeddings con un dataset de consultas legales especÃ­ficas de Ecuador para mejorar la captura de tÃ©rminos legales especializados.
                    </p>
                </li>
                <li>
                    <strong>BÃºsqueda HÃ­brida:</strong>
                    <p>
                        Combinar bÃºsqueda vectorial con bÃºsqueda de texto completo (BM25) para casos donde la bÃºsqueda exacta de tÃ©rminos es mÃ¡s efectiva.
                    </p>
                </li>
                <li>
                    <strong>A/B Testing de maxResults:</strong>
                    <p>
                        Realizar pruebas para determinar el valor Ã³ptimo de maxResults para diferentes tipos de consulta, considerando balance entre precisiÃ³n y latencia.
                    </p>
                </li>
            </ol>

            <h4>7.2.3. InvestigaciÃ³n a Largo Plazo</h4>

            <div class="alert alert-info">
                <strong>InvestigaciÃ³n - PrÃ³ximos 6 Meses</strong>
            </div>

            <ol>
                <li>
                    <strong>Modelos de Lenguaje Especializados en Legal:</strong>
                    <p>
                        Evaluar modelos de embeddings especializados en documentos legales en espaÃ±ol (ej: legal-spanish-bert).
                    </p>
                </li>
                <li>
                    <strong>Graph RAG para Referencias Cruzadas:</strong>
                    <p>
                        Implementar un grafo de conocimiento que conecte artÃ­culos relacionados, permitiendo navegaciÃ³n contextual automÃ¡tica.
                    </p>
                </li>
                <li>
                    <strong>Feedback Loop de Usuario:</strong>
                    <p>
                        Implementar sistema de feedback donde usuarios puedan indicar si la respuesta fue Ãºtil, para aprendizaje continuo del sistema.
                    </p>
                </li>
            </ol>

            <h3>7.3. MÃ©tricas de Ã‰xito Definidas</h3>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>MÃ©trica</th>
                            <th>Antes</th>
                            <th>DespuÃ©s</th>
                            <th>Objetivo 6 Meses</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Tasa de Ã‰xito - ArtÃ­culos</td>
                            <td>0%</td>
                            <td><strong>100%</strong></td>
                            <td>100%</td>
                        </tr>
                        <tr>
                            <td>Latencia Promedio</td>
                            <td>1.8s</td>
                            <td>2.3s</td>
                            <td>&lt; 2.0s</td>
                        </tr>
                        <tr>
                            <td>PrecisiÃ³n Top-5</td>
                            <td>N/A</td>
                            <td>100%</td>
                            <td>100%</td>
                        </tr>
                        <tr>
                            <td>Cobertura de Formatos</td>
                            <td>1</td>
                            <td>4</td>
                            <td>10+</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>7.4. Riesgos y Mitigaciones</h3>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Riesgo</th>
                            <th>Probabilidad</th>
                            <th>Impacto</th>
                            <th>MitigaciÃ³n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Aumento de costos de OpenAI API</td>
                            <td>Media</td>
                            <td>Bajo</td>
                            <td>Implementar cache de embeddings, monitorear uso</td>
                        </tr>
                        <tr>
                            <td>Latencia excesiva con muchos tÃ©rminos</td>
                            <td>Baja</td>
                            <td>Medio</td>
                            <td>Limitar nÃºmero de variaciones generadas, paralelizar</td>
                        </tr>
                        <tr>
                            <td>False positives en detecciÃ³n de patrones</td>
                            <td>Media</td>
                            <td>Bajo</td>
                            <td>ValidaciÃ³n de contexto, logging detallado</td>
                        </tr>
                        <tr>
                            <td>Escalabilidad con mÃ¡s documentos</td>
                            <td>Media</td>
                            <td>Alto</td>
                            <td>Optimizar queries PostgreSQL, considerar Ã­ndices adicionales</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section" id="apendices">
            <h2>8. ApÃ©ndices</h2>

            <h3>ApÃ©ndice A: Referencias TÃ©cnicas</h3>
            <ul>
                <li>OpenAI Embeddings API: <code>text-embedding-ada-002</code></li>
                <li>OpenAI Chat Completions API: <code>gpt-4</code></li>
                <li>PostgreSQL with pgvector extension</li>
                <li>Fastify Web Framework v4.x</li>
                <li>Prisma ORM v5.x</li>
            </ul>

            <h3>ApÃ©ndice B: Patrones Regex Utilizados</h3>
            <pre><code>// DetecciÃ³n de referencias a artÃ­culos
const patterns = [
  /art(?:Ã­|i)culo\s*(\d+)/gi,  // "artÃ­culo 100" o "articulo 100"
  /art\.\s*(\d+)/gi,            // "art. 100" (con espacio)
  /art\s+(\d+)/gi,              // "art 100" (sin punto)
  /art\.(\d+)/gi,               // "art.100" (sin espacio)
];</code></pre>

            <h3>ApÃ©ndice C: FÃ³rmula de Similitud Coseno</h3>
            <pre><code>function cosineSimilarity(vecA: number[], vecB: number[]): number {
  let dotProduct = 0;
  let normA = 0;
  let normB = 0;

  for (let i = 0; i < vecA.length; i++) {
    dotProduct += vecA[i] * vecB[i];
    normA += vecA[i] * vecA[i];
    normB += vecB[i] * vecB[i];
  }

  normA = Math.sqrt(normA);
  normB = Math.sqrt(normB);

  if (normA === 0 || normB === 0) {
    return 0;
  }

  return dotProduct / (normA * normB);
}</code></pre>

            <h3>ApÃ©ndice D: Estructura de Datos de Respuesta</h3>
            <pre><code>{
  "answer": "El artÃ­culo 100 de la ConstituciÃ³n...",
  "sources": [
    {
      "documentId": "426af1d2-7204-4f94-97e1-9892e4f54c47",
      "documentTitle": "CONSTITUCIÃ“N DE LA REPÃšBLICA DEL ECUADOR",
      "chunkIndex": 100,
      "similarity": 0.8195499473033228,
      "content": "rechos constitucionales...",
      "source": "legal",
      "normType": "CONSTITUTIONAL_NORM",
      "legalHierarchy": "CONSTITUCION"
    }
  ],
  "query": "art.100",
  "caseId": "144b9075-9a64-454c-a2d2-5ee9deec59d8"
}</code></pre>

            <h3>ApÃ©ndice E: Comandos de Prueba</h3>
            <pre><code># AutenticaciÃ³n
curl -X POST https://legal-rag-api-qnew.onrender.com/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password"}'

# Query con formato estÃ¡ndar
curl -X POST https://legal-rag-api-qnew.onrender.com/api/v1/query \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer TOKEN" \
  -d '{"caseId":"CASE_ID","query":"Art. 100"}'

# Query en lenguaje natural
curl -X POST https://legal-rag-api-qnew.onrender.com/api/v1/query \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer TOKEN" \
  -d '{"caseId":"CASE_ID","query":"que dice el articulo 100","maxResults":20}'</code></pre>

            <h3>ApÃ©ndice F: Glosario de TÃ©rminos</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>TÃ©rmino</th>
                            <th>DefiniciÃ³n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>RAG</strong></td>
                            <td>Retrieval-Augmented Generation - TÃ©cnica que combina bÃºsqueda de informaciÃ³n con generaciÃ³n de texto por IA</td>
                        </tr>
                        <tr>
                            <td><strong>Embedding</strong></td>
                            <td>RepresentaciÃ³n vectorial de texto en espacio de alta dimensionalidad</td>
                        </tr>
                        <tr>
                            <td><strong>Similitud Coseno</strong></td>
                            <td>Medida de similitud entre dos vectores basada en el Ã¡ngulo entre ellos</td>
                        </tr>
                        <tr>
                            <td><strong>Chunk</strong></td>
                            <td>Fragmento de documento dividido para procesamiento vectorial</td>
                        </tr>
                        <tr>
                            <td><strong>maxResults</strong></td>
                            <td>NÃºmero mÃ¡ximo de chunks a recuperar en bÃºsqueda vectorial</td>
                        </tr>
                        <tr>
                            <td><strong>GPT-4</strong></td>
                            <td>Modelo de lenguaje de OpenAI usado para generar respuestas</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="footer">
            <p><strong>Documento TÃ©cnico - Sistema Legal RAG</strong></p>
            <p>VersiÃ³n 1.0 | 10 de Noviembre, 2025</p>
            <p>Â© 2025 Legal RAG API Project. Todos los derechos reservados.</p>
        </div>
    </div>
</body>
</html>